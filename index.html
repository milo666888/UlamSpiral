<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>質數分布教具：烏拉螺旋 vs 極坐標螺旋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --accent:#38bdf8;
      --accent-soft:#1d4ed8;
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#1e293b,#020617 55%);
      font-family:system-ui,-apple-system,"Microsoft JhengHei",sans-serif;
      color:var(--text);
      overflow-x: hidden;
    }
    .page{
      width:min(1280px,100vw - 24px);
      margin:16px auto;
      padding:16px;
      background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.9));
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.75);
      border:1px solid rgba(148,163,184,0.15);
    }
    .page-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:10px;
      gap:8px;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:0.02em;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
    }

    /* ===== 電腦版佈局 (完全不動) ===== */
    .page-main{
      margin-top:6px;
      display:grid;
      grid-template-columns:1.05fr 1.55fr;
      gap:18px;
    }
    .panel{
      background:var(--panel);
      border-radius:14px;
      padding:14px 16px 16px;
      border:1px solid rgba(30,64,175,0.45);
    }
    .panel h2{
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }
    p{
      margin:0 0 6px;
      font-size:13px;
      line-height:1.6;
    }
    label{
      display:block;
      margin:8px 0 2px;
      font-size:13px;
    }
    input[type="number"]{
      width:190px;
      max-width:100%;
      padding:5px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    input[type="number"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .presets{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }
    .presets button{
      padding:4px 10px;
      border-radius:999px;
      border:none;
      background:var(--accent-soft);
      color:#e5e7eb;
      cursor:pointer;
      font-size:12px;
      font-weight:500;
    }
    .presets button:hover{ filter:brightness(1.1); }
    button.main{
      margin-top:10px;
      padding:7px 16px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#0b1120;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      width:auto;
    }
    button.main:disabled{
      opacity:.55;
      cursor:default;
    }
    .info{
      margin-top:10px;
      font-size:13px;
      color:#cbd5f5;
    }
    .info small{
      color:var(--muted);
      font-size:12px;
    }
    .mode-group{
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.5);
      font-size:13px;
    }
    .mode-group span{
      display:block;
      margin-bottom:4px;
      color:#e5e7eb;
      font-weight:500;
    }
    .mode-group label{
      display:inline-flex;
      align-items:center;
      margin:0 10px 4px 0;
      font-size:13px;
      cursor:pointer;
    }
    .mode-group input{
      margin-right:4px;
    }
    
    /* ===== 畫布與 Logo ===== */
    .canvas-shell{
      background:#020617;
      border-radius:14px;
      padding:8px;
      border:1px solid rgba(148,163,184,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      overflow: hidden;
    }
    
    canvas{
      display:block;
      background:#ffffff;
      border-radius:12px;
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
    }

    .company-logo {
      position: absolute;
      right: 24px;
      bottom: 24px;
      height: 45px;
      width: auto;
      opacity: 0.8;
      pointer-events: none;
      z-index: 10;
    }

    /* 手機專用底部控制列 - 電腦版隱藏 */
    .mobile-footer {
      display: none;
    }

    /* ===== 手機版調整 (Media Query) ===== */
    @media (max-width: 768px){
      body { align-items: flex-start; }
      .page {
        margin: 8px auto;
        padding: 10px;
        width: calc(100vw - 16px);
      }
      .page-header { flex-direction: column; align-items: flex-start; }
      .page-main { grid-template-columns: 1fr; gap: 10px; }

      /* 面板變為彈出式側邊選單 */
      .panel {
        position: fixed;
        top: 0;
        left: -320px; 
        width: 300px;
        height: 100vh;
        z-index: 2000;
        transition: left 0.3s ease;
        border-radius: 0 18px 18px 0;
        box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        overflow-y: auto;
      }
      .panel.open { left: 0; }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        z-index: 1999;
      }
      .overlay.show { display: block; }

      /* 手機版：隱藏畫布內部的 Logo (因為我們要放到右下角並列) */
      .canvas-shell .company-logo { display: none; }

      /* 手機版專屬底部按鈕區域 */
      .mobile-footer {
        display: flex;
        position: fixed;
        bottom: 20px;
        right: 20px;
        gap: 12px;
        align-items: center;
        z-index: 1001;
      }

      /* 手機版設定按鈕與 LOGO 大小一致 */
      .mobile-menu-btn {
        width: 40px;
        height: 40px;
        background: var(--accent);
        border-radius: 8px; /* 方圓形，配合 LOGO 感 */
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
      .mobile-menu-btn svg {
        fill: #0b1120;
        width: 24px;
        height: 24px;
      }

      .footer-logo {
        height: 40px;
        width: auto;
        opacity: 0.9;
        pointer-events: none;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
      }

      #mobileClose { display: block !important; }
    }
  </style>
</head>
<body>

  <div class="overlay" id="overlay"></div>

  <div class="mobile-footer">
    <button class="mobile-menu-btn" id="menuToggle">
      <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
    </button>
    <img src="company-logo.PNG" alt="LOGO" class="footer-logo">
  </div>

  <div class="page">
    <div class="page-header">
      <div>
        <div class="title">質數分布教具</div>
        <div class="subtitle">方形烏拉螺旋 vs 極坐標螺旋 (r = p, θ = p)</div>
      </div>
      <div class="subtitle">
        建議先看烏拉螺旋的方形坐標，再切換到極坐標螺旋比較圖形規律。
      </div>
    </div>

    <div class="page-main">
      <div class="panel" id="panel">
        <h2>參數設定</h2>
        <p>
          本教具只取質數 p。<br>
          「烏拉螺旋」：將 1～n 依方形螺旋填入格子，只用黑點標出質數位置。<br>
          「極坐標螺旋」：在平面上以 r = p、θ = p（弧度）描黑點。
        </p>

        <label for="inputN">最大 n（100 ～ 5,000,000）：</label>
        <input id="inputN" type="number" value="300000" min="100" max="5000000" step="100">
        <div class="hint">n 越大，圖形越細緻；但運算與繪圖時間也會增加。</div>

        <div class="presets">
          快速選擇：
          <button type="button" data-n="5000">5,000</button>
          <button type="button" data-n="20000">20,000</button>
          <button type="button" data-n="100000">100,000</button>
          <button type="button" data-n="300000">300,000</button>
          <button type="button" data-n="1000000">1,000,000</button>
        </div>

        <div class="mode-group">
          <span>圖形模式：</span>
          <label>
            <input type="radio" name="mode" value="ulam" checked>
            烏拉螺旋（方形坐標）
          </label>
          <label>
            <input type="radio" name="mode" value="polar">
            極坐標螺旋
          </label>
          <div class="hint" style="margin-top:4px;">
            烏拉螺旋模式建議 n ≤ 500,000，比較不會太慢，黑點分布也較清楚。
          </div>
        </div>

        <button id="btnDraw" class="main">重新繪製</button>

        <div class="info" id="info">尚未繪製。</div>
        <div class="info">
          <small>教學建議：先固定 n，只切換模式比較兩種坐標；再改變 n 看螺旋、對角線與放射線的變化。</small>
        </div>
        
        <button class="main" style="background:#475569; color:white; width:100%; margin-top:20px; display:none;" id="mobileClose">關閉設定</button>
      </div>

      <div class="canvas-shell">
        <canvas id="canvas"></canvas>
        <img src="company-logo.png" alt="LOGO" class="company-logo">
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const inputN = document.getElementById("inputN");
    const btnDraw = document.getElementById("btnDraw");
    const info = document.getElementById("info");
    const presetButtons = document.querySelectorAll(".presets button");
    const modeRadios = document.querySelectorAll("input[name='mode']");
    
    // 手機選單控制元件
    const panel = document.getElementById("panel");
    const overlay = document.getElementById("overlay");
    const menuToggle = document.getElementById("menuToggle");
    const mobileClose = document.getElementById("mobileClose");

    function openMenu() {
      panel.classList.add("open");
      overlay.classList.add("show");
    }
    function closeMenu() {
      panel.classList.remove("open");
      overlay.classList.remove("show");
    }

    menuToggle.addEventListener("click", openMenu);
    overlay.addEventListener("click", closeMenu);
    mobileClose.addEventListener("click", closeMenu);

    let logicalSize = 600;
    let currentN = parseInt(inputN.value, 10) || 300000;
    let currentMode = "ulam";

    function resizeSquare() {
      const isMobile = window.innerWidth <= 768;
      let cssSize;
      if (isMobile) {
        cssSize = Math.min(window.innerWidth - 24, window.innerHeight * 0.65);
      } else {
        cssSize = Math.min(window.innerWidth * 0.55, window.innerHeight * 0.7);
      }
      const dpr = window.devicePixelRatio || 1;
      logicalSize = cssSize;
      canvas.style.width = cssSize + "px";
      canvas.style.height = cssSize + "px";
      canvas.width = cssSize * dpr;
      canvas.height = cssSize * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener("resize", () => {
      resizeSquare();
      draw(currentN, currentMode, false); // resize 時不收合選單
    });

    resizeSquare();

    function sieve(limit) {
      const arr = new Uint8Array(limit + 1);
      arr[0] = 1; arr[1] = 1;
      const s = Math.floor(Math.sqrt(limit));
      for (let i = 2; i <= s; i++) {
        if (!arr[i]) {
          for (let j = i * i; j <= limit; j += i) arr[j] = 1;
        }
      }
      return arr;
    }

    function drawPolar(N, isComposite) {
      const cx = logicalSize / 2;
      const cy = logicalSize / 2;
      const maxR = Math.min(cx, cy) - 10;
      const scale = maxR / N;
      const dot = 0.9;
      ctx.fillStyle = "#000000";
      for (let p = 2; p <= N; p++) {
        if (isComposite[p]) continue;
        const r = p * scale;
        const theta = p;
        const x = cx + r * Math.cos(theta);
        const y = cy + r * Math.sin(theta);
        ctx.fillRect(x, y, dot, dot);
      }
    }

    function drawUlam(N, isComposite) {
      let side = Math.ceil(Math.sqrt(N));
      if (side % 2 === 0) side++;
      const cell = logicalSize / side;
      const dot = Math.max(cell * 0.45, 0.4);
      ctx.fillStyle = "#000000";
      const cx = Math.floor(side / 2);
      const cy = Math.floor(side / 2);

      function drawDot(ix, iy, num) {
        if (num < 2 || num > N || isComposite[num]) return;
        const px = ix * cell + (cell - dot) / 2;
        const py = iy * cell + (cell - dot) / 2;
        ctx.fillRect(px, py, dot, dot);
      }

      let x = cx, y = cy, n = 1;
      const dirs = [[1,0],[0,-1],[-1,0],[0,1]];
      let stepLen = 1, dirIndex = 0;
      while (n <= N) {
        for (let rep = 0; rep < 2; rep++) {
          const [dx, dy] = dirs[dirIndex % 4];
          for (let s = 0; s < stepLen; s++) {
            drawDot(x, y, n);
            x += dx; y += dy; n++;
            if (n > N) return;
          }
          dirIndex++;
        }
        stepLen++;
      }
    }

    /**
     * @param {boolean} shouldClose - 是否在繪製後收合手機選單
     */
    function draw(N, mode, shouldClose = false) {
      currentN = N;
      currentMode = mode;
      btnDraw.disabled = true;
      info.textContent = `計算中…`;
      
      setTimeout(() => {
        const isComposite = sieve(N);
        ctx.clearRect(0, 0, logicalSize, logicalSize);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, logicalSize, logicalSize);
        if (mode === "ulam") drawUlam(N, isComposite);
        else drawPolar(N, isComposite);
        
        let cnt = 0;
        for (let i = 2; i <= N; i++) if (!isComposite[i]) cnt++;
        info.textContent = `完成：n = ${N.toLocaleString()}，質數 ${cnt.toLocaleString()} 個。`;
        btnDraw.disabled = false;
        
        // 只有明確要求時 (例如按下「重新繪製」)，才在手機版收合選單
        if(shouldClose && window.innerWidth <= 768) closeMenu();
      }, 10);
    }

    presetButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const n = parseInt(btn.dataset.n, 10);
        inputN.value = n;
        draw(n, currentMode, false); // 快速選擇時「不」收合選單
      });
    });

    modeRadios.forEach(r => {
      r.addEventListener("change", () => {
        if (r.checked) {
          currentMode = r.value;
          draw(currentN, currentMode, false); // 切換模式時「不」收合選單
        }
      });
    });

    btnDraw.addEventListener("click", () => {
      let N = parseInt(inputN.value, 10) || 100000;
      N = Math.max(100, Math.min(5000000, N));
      inputN.value = N;
      draw(N, currentMode, true); // 只有點擊「重新繪製」才會收合選單
    });

    // 初始繪製
    draw(currentN, currentMode, false);
  </script>
</body>
</html>
